{
  "active": true,
  "connections": {
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenWeatherMap": {
      "ai_tool": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Wikipedia": {
      "ai_tool": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Translate a language in DeepL": {
      "ai_tool": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "ai_tool": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "HTTP Request2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2": {
      "main": [
        [
          {
            "node": "Parse OCR Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse OCR Output": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Image AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Text AI Agent": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Image AI Agent": {
      "main": [
        [
          {
            "node": "南聯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set": {
      "main": [
        [
          {
            "node": "Image AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Brave": {
      "ai_tool": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Image AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "SearXNG": {
      "ai_tool": [
        [
          {
            "node": "Text AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Set",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "南聯": {
      "main": [
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "HTTP Request5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Text AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request5": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-20T10:29:20.515Z",
  "id": "OlmUnWHBwAwUhvbX",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Online",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        864,
        -60
      ],
      "id": "d85367e1-1ace-4f6f-a7c2-18bbb319922c",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "BhRebVZ9DRCV4K9x",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "cityName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('City', ``, 'string') }}",
        "language": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Language', ``, 'string') }}"
      },
      "type": "n8n-nodes-base.openWeatherMapTool",
      "typeVersion": 1,
      "position": [
        1120,
        -60
      ],
      "id": "20d26101-7b0b-4692-aaed-f039299649f8",
      "name": "OpenWeatherMap",
      "credentials": {
        "openWeatherMapApi": {
          "id": "WtdLhGwtkgEHTzcf",
          "name": "OpenWeatherMap account"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolWikipedia",
      "typeVersion": 1,
      "position": [
        1248,
        -60
      ],
      "id": "975ada8d-5246-489a-bce3-320e27f72549",
      "name": "Wikipedia"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        1376,
        -60
      ],
      "id": "00280217-9a59-450a-b007-9a04e0d28512",
      "name": "Calculator"
    },
    {
      "parameters": {
        "text": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Text', ``, 'string') }}",
        "translateTo": "ZH-HANT",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.deepLTool",
      "typeVersion": 1,
      "position": [
        1504,
        -60
      ],
      "id": "15f68ae9-fa28-431c-af32-906065ca31fd",
      "name": "Translate a language in DeepL",
      "credentials": {
        "deepLApi": {
          "id": "k5VPmGahKTUTGmak",
          "name": "DeepL account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "callback",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1280,
        -556
      ],
      "id": "5681d773-5db4-4059-aec3-4e107bad7b89",
      "name": "Webhook",
      "webhookId": "21c6171d-a9e9-4161-b787-1738d6d9153c"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"replyToken\":\"{{ $('Webhook').item.json.body.events[0].replyToken }}\",\n    \"messages\":[\n        {\n            \"type\":\"text\",\n            \"text\": {{ JSON.stringify($json.output) }}\n        }\n    ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2096,
        -284
      ],
      "id": "92dc270f-0ed8-4bd9-b906-71aeeb6d11b8",
      "name": "HTTP Request",
      "credentials": {
        "httpQueryAuth": {
          "id": "STyubl0nA6m9Gpfa",
          "name": "Query Auth account"
        },
        "httpHeaderAuth": {
          "id": "XhkvUemEast99W3j",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "includeTime": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Include_Current_Time', ``, 'boolean') }}",
        "outputFieldName": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Output_Field_Name', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        1632,
        -60
      ],
      "id": "ad9e7241-ea17-4c83-8164-458dcc351e0c",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "url": "=https://api-data.line.me/v2/bot/message/{{ $json.body.events[0].message.id }}/content",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer AlaeI3rhCXsNjvpId/OCherfCv7cakAVoMRqDtTeNcsTIjEm4wMROeWuae9tittYNeNQHQhO9RTB218hNcqNVhwzYqF+si1aabauaTXDsvByXKx0qPFaDUxdcHfvW2RR5PPnHJRW8lDUMdtB32uPzQdB04t89/1O/w1cDnyilFU="
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "line_image_data"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -832,
        -800
      ],
      "id": "d7ee5948-b2b8-41e3-b48b-34136c5100aa",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://gionie-my-fastapi-paddleocr.hf.space/ocr",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "line_image_data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -608,
        -800
      ],
      "id": "57d88564-d5b8-4cc3-8a51-0d942187f79f",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"replyToken\": \"{{ $('Webhook').item.json.body.events[0].replyToken }}\",\n  \"messages\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"✅ Invoice Generated Successfully!\"\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2096,
        -704
      ],
      "id": "3a06ef5e-cfd6-43d3-9542-3023dca85d8b",
      "name": "HTTP Request3",
      "credentials": {
        "httpQueryAuth": {
          "id": "STyubl0nA6m9Gpfa",
          "name": "Query Auth account"
        },
        "httpHeaderAuth": {
          "id": "XhkvUemEast99W3j",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "42ed21c2-7a41-4b66-a8e0-84daef8d7640",
              "leftValue": "={{ $json.body.events[0].message.type }}",
              "rightValue": "image",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1056,
        -556
      ],
      "id": "d543af01-e996-47b7-8c85-37b13f62e042",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Get the OCR response\nconst ocrResponse = $input.all()[0].json;\n\n// Extract text from detections array\nconst detections = ocrResponse.detections || [];\nconst texts = detections.map(d => d.text);\nconst combinedText = texts.join(' ');\n\n// Get replyToken from webhook\nconst webhookData = $node[\"Webhook\"].json;\nconst replyToken = webhookData.body.events[0].replyToken;\n\n// Include both structured and combined text\nreturn [{\n  json: {\n    fullText: combinedText,\n    detections: detections,\n    replyToken: replyToken\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        -800
      ],
      "id": "4c691ed5-0fbb-47d2-9539-493b05eccb63",
      "name": "Parse OCR Output"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        296,
        -576
      ],
      "id": "ae48ce65-7067-4fee-9037-ab517f3c5910",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "BhRebVZ9DRCV4K9x",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.events[0].message.text }}",
        "options": {
          "systemMessage": "繁體中文AI助手。**永遠中文回答**。\n\n工具順序：\n- 天氣→OpenWeatherMap (使用英文城市名)\n- 計算→Calculator\n- 翻譯→DeepL\n- 所有你無法回答的問題資料查詢：\n  1. Wikipedia（快速事實）\n  2. SearXNG（其餘一般搜尋）\n  3. Brave（需要2個答案來交叉比對時、當其他失敗時）\n\n搜尋策略：\n- 如果 Wikipedia 失敗 → 立即嘗試 SearXNG\n- 如果 SearXNG 也失敗 → 使用 Brave Search\n- 搜尋關鍵字要簡潔（1-6 個詞）\n- 盡量使用英文搜尋以獲得更好結果\n- 盡量得到使用兩種以上答案交叉比對真實性\n\n重要規則：\n1. 不確定的問題→**立即使用搜尋工具**，禁止建議用戶自己查\n2. 禁止重複用戶的問題\n3. 禁止說\"我不知道\"而不搜尋\n4. 回答用中英交叉得到答案\n5. 答案用你本身知識+Wikipedia→SearXNG(再加Brave如有需要)交叉比對確認無誤\n6. 工具失敗時不要停止，嘗試下一個工具\n\n找到資訊後用現有答案交叉比對確認無誤簡潔概括，用繁體中文回答。",
          "maxIterations": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1304,
        -284
      ],
      "id": "39acfd02-520e-4a02-94be-c7a0e52b5657",
      "name": "Text AI Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json[\"input_text\"] }}",
        "options": {
          "systemMessage": "=You are a Senior Logistics Data Auditor. Your task is to **Classify** and **Parse** the following OCR text from a shipping invoice.\n**Input Data:**\n{{ $json[\"input_text\"] }}\n**Step 1: Classify**\nDetermine if the invoice is:\n- \"南聯\" (Keywords: 起訖地點, 運價, 補貼)\n- \"大茂\" (Keywords: 尚和, 大茂, 送貨地點, 載運重量)\n- \"成偉\" (Keywords: 尚和, 成偉, 送貨地點(起))\n**Step 2: Parse & Correct (Apply Logic)**\nExtract the data into a structured JSON array based on the type.\n- **Fix Dates**: Dates must be ascending (e.g., if 5/1, 5/2, 9/4, 5/5 -> Correct 9/4 to 5/4).\n- **Fix Locations**: \n    - Nanlian: Map \"兆信(林口)\" -> \"兆信林\", \"長坤(桃)\" -> \"長坤桃\".\n    - Split Start/End: \"三信倉 - 台中倉\" -> Start: \"三信倉\", End: \"台中倉\".\n- **Fix Numbers**: \n    - **Weight Decimal Fix**: If Weight > 100, it is likely missing a decimal point. (e.g., \"3300\" -> 33.00, \"20325\" -> 20.325).\n    - **Weight vs Price**: If Weight is > 35 (even after decimal fix check), it might be a Price.\n    - **Subsidy Logic**: \n        - If text contains \"500\" AND (\"X2\" or \"x2\" or \"2\"), Subsidy = 1000.\n        - If text contains \"併\" AND (\"X2\" or \"x2\"), Subsidy = 1000.\n        - If text contains \"併\", Subsidy = 500.\n        - Otherwise, if text is \"500\" or \"1000\", keep it.\n- **Fix Memo**:\n    - Do NOT put \"500\", \"X2\", or \"併\" in the Memo field.\n    - Only include real notes (e.g., \"底趨\"). If none, leave empty \"\".\n**Step 3: Output JSON**\nReturn a SINGLE JSON object with this exact structure:\n**If Nanlian:**\n```json\n{\n  \"companyType\": \"南聯\",\n  \"dataRows\": [\n    [\"5/1\", \"桃園倉\", \"路竹倉\", 20.325, 500, \"\"],\n    [\"5/2\", \"禮佳倉\", \"台中倉\", 25.834, 0, \"\"]\n  ]\n}\n(Format: [Date, Start, End, Weight, Subsidy, Memo])\n\nIf Damao:\n\n{\n  \"companyType\": \"大茂\",\n  \"dataRows\": [\n    [\"5/1\", \"全聯-岡山\", 15.2, \"KG\", 12500]\n  ]\n}\n(Format: [Date, Location, Weight, Unit, Amount])\n\nIf Chengwei:\n\n{\n  \"companyType\": \"成偉\",\n  \"dataRows\": [\n    [\"5/1\", \"觀音-全聯\", 15, \"板\", 4500]\n  ]\n}\n(Format: [Date, Location, Quantity, Unit, Amount])"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        288,
        -800
      ],
      "id": "dfc66664-c15c-4816-91c4-8fb4cd5b8721",
      "name": "Image AI Agent"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "36f07311-d43b-4953-ae0d-42c944d2483e",
              "name": "replyToken",
              "value": "={{ $json[\"replyToken\"] }}",
              "type": "string"
            },
            {
              "id": "d0125b28-007d-4ea9-b538-b7f99d5feea8",
              "name": "input_text",
              "value": "={{ $json[\"fullText\"] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        64,
        -800
      ],
      "id": "c4f6dd39-a01c-47ef-b9d6-660b4ad9c4e3",
      "name": "Set"
    },
    {
      "parameters": {
        "toolDescription": "Brave Search online tool",
        "url": "https://api.search.brave.com/res/v1/web/search",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "=q",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters0_Value', ``, 'string') }}"
            },
            {
              "name": "count",
              "value": "3"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=X-Subscription-Token",
              "value": "=BSAbIjHxTHqAcA4Mz7kEJ-22QINZy7H"
            },
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        1760,
        -60
      ],
      "id": "4f2aa113-874e-42db-9895-38884b405e7c",
      "name": "Brave",
      "credentials": {
        "httpHeaderAuth": {
          "id": "XhkvUemEast99W3j",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.replyToken }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        424,
        -576
      ],
      "id": "8e5a75bc-b7ee-4ea0-8278-fcc22afe4fe4",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.body.events[0].source.userId }}",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        992,
        -60
      ],
      "id": "57721f3d-4641-409c-985a-add1925a5eb8",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.toolSearXng",
      "typeVersion": 1,
      "position": [
        1888,
        -60
      ],
      "id": "80066452-7fac-46a5-9c46-ec5eca1635db",
      "name": "SearXNG",
      "credentials": {
        "searXngApi": {
          "id": "VMYqRADbkXv0ZfDl",
          "name": "SearXNG account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get input with detections\nconst input = $input.all()[0].json;\n\n// Sort detections by vertical position\nconst sortedDetections = input.detections.sort((a, b) => {\n    return a.position.top_left.y - b.position.top_left.y;\n});\n\n// Group texts by line based on y-position\nconst lineThreshold = 10; // pixels\nconst lines = [];\nlet currentLine = [];\nlet lastY = -1;\n\nsortedDetections.forEach(detection => {\n    const y = detection.position.top_left.y;\n    if (lastY === -1 || Math.abs(y - lastY) <= lineThreshold) {\n        currentLine.push(detection);\n    } else {\n        if (currentLine.length > 0) {\n            lines.push(currentLine);\n        }\n        currentLine = [detection];\n    }\n    lastY = y;\n});\nif (currentLine.length > 0) {\n    lines.push(currentLine);\n}\n\n// Sort each line horizontally and extract text\nconst processedText = lines\n    .map(line => line\n        .sort((a, b) => a.position.top_left.x - b.position.top_left.x)\n        .map(d => d.text)\n        .join(' ')\n    )\n    .join('\\n');\n\n// Return both processed text and original data\nreturn {\n    json: {\n        fullText: processedText,\n        structuredText: lines.map(line => ({\n            text: line\n                .sort((a, b) => a.position.top_left.x - b.position.top_left.x)\n                .map(d => d.text)\n                .join(' '),\n            confidence: Math.min(...line.map(d => d.confidence))\n        })),\n        replyToken: input.replyToken\n    }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -160,
        -800
      ],
      "id": "c3aeba46-8a6a-4825-a95d-ae452578fcfd",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://gionie-my-fastapi-paddleocr.hf.space/accumulate",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"userId\": \"{{ $('Webhook').item.json.body.events[0].source.userId }}\",\n  \"dataRows\": {{ JSON.stringify($json.dataRows) }},\n  \"companyType\": \"{{ $json.companyType }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1368,
        -800
      ],
      "id": "1db0ee6e-7f35-4842-83de-a92eed1a9045",
      "name": "HTTP Request4"
    },
    {
      "parameters": {
        "jsCode": "const aiOutputText = $input.item.json.output || '{}';\nlet parsedOutput = { dataRows: [], companyType: \"Unknown\" };\ntry {\n    // Extract JSON from Markdown if present\n    const jsonMatch = aiOutputText.match(/\\{[\\s\\S]*\\}/);\n    const jsonStr = jsonMatch ? jsonMatch[0] : aiOutputText;\n    parsedOutput = JSON.parse(jsonStr);\n} catch (e) {\n    // Fallback: Try to use the raw text if parsing fails\n}\n// Ensure dataRows exists\nconst dataRows = Array.isArray(parsedOutput.dataRows) ? parsedOutput.dataRows : [];\nconst companyType = parsedOutput.companyType || \"南聯\";\nreturn {\n    json: {\n        companyType: companyType,\n        dataRows: dataRows,\n        totalAmount: 0 // Calculated by Python\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        640,
        -800
      ],
      "id": "7745d7e8-7a03-47bd-915c-352a79315dc8",
      "name": "南聯"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3971300e-19fd-4ec6-8349-d934eaa60a76",
              "leftValue": "={{ $json.body.events[0].message.text }}",
              "rightValue": "結算",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        640,
        -432
      ],
      "id": "83017467-0583-43bb-8cb0-c735167b1c0a",
      "name": "If1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://gionie-my-fastapi-paddleocr.hf.space/generate_batch",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"userId\": \"{{ $('Webhook').item.json.body.events[0].source.userId }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1368,
        -580
      ],
      "id": "4db9788d-f38b-4a31-8f0c-b2c477900332",
      "name": "HTTP Request5"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "x-forwarded-for": "147.92.149.169",
            "x-forwarded-proto": "https",
            "x-forwarded-port": "443",
            "host": "gionie-n8n-free.hf.space",
            "x-amzn-trace-id": "Root=1-69200557-1de3938d266fc67a1e1d918f",
            "content-length": "816",
            "x-line-signature": "rljLQausGYRiP23vfLMbe6+r35VDOVPj97TTKNNAmYg=",
            "content-type": "application/json; charset=utf-8",
            "user-agent": "LineBotWebhook/2.0",
            "x-request-id": "_cU7XM, _cU7XM",
            "x-direct-url": "https://gionie-n8n-free.hf.space/--replicas/8tfs9/webhook/callback"
          },
          "params": {},
          "query": {},
          "body": {
            "destination": "Ua5a2f6a998c71ce952b6621833b460ed",
            "events": [
              {
                "type": "message",
                "message": {
                  "type": "image",
                  "id": "588670387622510627",
                  "quoteToken": "BYgF9cdou1mcsXHO2a_6_oKyjJur97kisHGNrkjRLLwBjpTpQgXHeuGpZS_jX7EXYYU127a4GjtATzUlfh77iLGicTppHpjm6qMWqLKWD8Z0dgQrQCH_d3EnE1Dc4QklMbmrFUazneJLtWr9nvxIrg",
                  "markAsReadToken": "YWaJijLT2gfO0D0HR7gkaFhnS6AnMqb3oZGl0l5sYwspN-2KVKdYGMlVUbgtmwi1ba4k6w6UoQaW2OsaeHnPrmZyDallIeUH7Y-wJSnS1F12SQyPHmrhP-VaeuxFonomXF0sX6e9ihO6csvKEU6nPSp4K63ZqkA4L2Lx4rJGJyfNqH5_FuBSpaGZHy_ABC9w3m3a5yS5xDppsMeJHSTb6A",
                  "contentProvider": {
                    "type": "line"
                  }
                },
                "webhookEventId": "01KAJH9PFR64FJXZ38NF4FRV01",
                "deliveryContext": {
                  "isRedelivery": false
                },
                "timestamp": 1763706198014,
                "source": {
                  "type": "user",
                  "userId": "U0e8f5ec2c86ea8542b4e67cc947c0f20"
                },
                "replyToken": "23da79f1e48c4c7e89fa14d7fd67d8a3",
                "mode": "active"
              }
            ]
          },
          "webhookUrl": "https://Gionie-n8n-free.hf.space/webhook/callback",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-10-20T10:29:20.515Z",
      "updatedAt": "2025-10-20T10:29:20.515Z",
      "role": "workflow:owner",
      "workflowId": "OlmUnWHBwAwUhvbX",
      "projectId": "SOgRqgJfaND0d4bJ"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-21T08:40:21.576Z",
  "versionId": "58ee0d2a-0bd6-401c-938e-e0da13d66e69"
}